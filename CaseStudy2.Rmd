---
title: "CaseStudy2"
author: "Jason Mcdonald"
date: "2/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(kableExtra)
library(corrplot)
library(RColorBrewer)
library(caret)
library(doParallel) #used code sample from https://topepo.github.io/caret/parallel-processing.html
library(yardstick) #recommended during research at https://rpubs.com/jkylearmstrong/knn_w_caret
library(e1071)
```

# Jason McDonald's Frito Lay Attrition Case Study

## Executive Summary
With current inflation data showing that inflation is outpacing wage growth drastically, employees are feeling an impact to their financial bottom line at home.  No longer can employees accept idle wage growth as such is accepting wage reductions when inflation is taken into account.

As a business, you must reward your employees financially with incentives that both satisfy their financial desires and address others they may have.

The question is, do we know what desires cause an employee to stay in a role?  Is it financial alone?  Is there some other factor which can cause an otherwise happy employee to leave?  Does this change over time, such as when inflation is growing at the rate it is now, in 2021 and 2022?

I've set out to provide you with insights using the data set you have provided, of 870 employees.


### Import the data
I was provided with 3 files containing employee data, 2 in Comma Separated Value format and 1 in Excel Workbook format which I then converted to CSV.  The first file contained data on 870 employees with a number of data points about each.  The second contained similar data points but no attrition data.  Finally, the third contained similar data points but no salary data.

Below, I will read in the data and begin to explore what columns and types of data exists in each.
```{r, Import Data}
trainData <- read.csv('CaseStudy2-data.csv')
attritionData <- read.csv('CaseStudy2CompSetNoAttrition.csv')
salaryData <- read.csv('CaseStudy2CompSetNoSalary.csv')
head(trainData)
```
### Look for missing data
I need to begin with a check to see if any data is missing and decide how to address that if so.
```{r}
which(is.na(trainData))
which(is.na(attritionData))
which(is.na(salaryData))
```
It looks like nothing is missing from the dataset, so I'll proceed to determine what I've been given and how I will need to clean the data to make it more suitable for predictive insights.
### Training Data Set
```{r, Training Variables}

#Display the columns in each data set in a table format
as.data.frame(lapply(trainData, class)) %>% t() %>% kable(bootstrap_options = "striped", full_width = F, position = "left") %>% kable_styling()
```
### No Attrition Data Set
```{r, No Attrition Variables}

#Display the columns in each data set in a table format
as.data.frame(lapply(attritionData, class)) %>% t() %>% kable() %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
### No Salary Data Set
```{r, No Salary Variables}

#Display the columns in each data set in a table format
as.data.frame(lapply(salaryData, class)) %>% t() %>% kable() %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
### Cleaning the data sets
There exists some columns which do not appear to contain data that will be useful going forward.  This could be due to the column not containing data that can be grouped into identifiable levels, such as ID, StandardHours, Employee Count, Over18, and EmployeeNumber.  
That work to remove them is done here.  
```{r, Clean Data}

#remove unneeded columns
removeVariables <- c("ID", "StandardHours", "EmployeeCount", "Over18", "EmployeeNumber")
trainData <- trainData[,!(names(trainData) %in% removeVariables)] 
attritionData <- attritionData[,!(names(attritionData) %in% removeVariables)]
salaryData <- salaryData[,!(names(salaryData) %in% removeVariables)]
```
### Cleaning the data sets - Parts 2
In addition to the columns that we won't need, there exist columns which need some transformation.  Notably Age and DistanceFromHome.  These are currently continious variables but will do better as ordinal variables using groups.  We define those groups below.
```{r, Clean Data 2}
#Age
trainData$AgeGroup <- with(trainData, ifelse(Age < 21, "18-20", ifelse(Age < 31, "21-30", ifelse(Age < 41, "31-40", ifelse(Age < 51, "41-50", ifelse(Age<61, "51-60", "> 60"))))))
attritionData$AgeGroup <- with(attritionData, ifelse(Age < 21, "18-20", ifelse(Age < 31, "21-30", ifelse(Age < 41, "31-40", ifelse(Age < 51, "41-50", ifelse(Age<61, "51-60", "> 60"))))))
salaryData$AgeGroup <- with(salaryData, ifelse(Age < 21, "18-20", ifelse(Age < 31, "21-30", ifelse(Age < 41, "31-40", ifelse(Age < 51, "41-50", ifelse(Age<61, "51-60", "> 60"))))))
#DistanceFromHome
trainData$WorkDistance <- with(trainData, ifelse(DistanceFromHome < 5, "<5 Miles", ifelse(DistanceFromHome < 11, "5-10", ifelse(DistanceFromHome < 16, "11-15", ifelse(DistanceFromHome < 21, "16-20", ifelse(DistanceFromHome<26, "21-25", "> 25"))))))
attritionData$WorkDistance <- with(attritionData, ifelse(DistanceFromHome < 5, "<5 Miles", ifelse(DistanceFromHome < 11, "5-10", ifelse(DistanceFromHome < 16, "11-15", ifelse(DistanceFromHome < 21, "16-20", ifelse(DistanceFromHome<26, "21-25", "> 25"))))))
salaryData$WorkDistance <- with(salaryData, ifelse(DistanceFromHome < 5, "<5 Miles", ifelse(DistanceFromHome < 11, "5-10", ifelse(DistanceFromHome < 16, "11-15", ifelse(DistanceFromHome < 21, "16-20", ifelse(DistanceFromHome<26, "21-25", "> 25"))))))

```
### Review what we've done so far
```{r, Review}
head(trainData)
```
### Analysis of correlation seen among variables in the data
I'll look now at a correlation matrix to determine where correlation exists between variables in the data set.
```{r, Correlation Check}
#build correlation data using all numeric variables
corrData <- cor(trainData[,sapply(trainData, is.numeric)])
corrplot(corrData, type="upper", order="hclust",
         col=brewer.pal(n=8, name="RdYlBu"))
```
### Handling Attrition as a data point
To be able to use attrition as a dat point, I will need it to be represented by numeric 1 or 0 for Yes or No. I will address that now.
```{r, Attrition to Numeric}
#head(trainData)
trainData$Attrition <- ifelse(trainData$Attrition=="Yes", 1, 0)
salaryData$Attrition <- ifelse(salaryData$Attrition=="Yes", 1, 0)
#head(trainData)
```
### Exploring those who left and those who didn't
I've seen the correlation data but what can I tell by looking at the mean values by whether or not an employee left Frito Lay?
```{r, Visualize the Data, warning=FALSE}
aggregate(trainData,by = list(trainData$Attrition),FUN = mean, na.rm=TRUE)  %>% kable() %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left") %>% scroll_box(height = 100, width = 800)
```
I see that the average age of an employee that left is about 4 years higher than one who did not leave during this period.  A leaving employee typically was higher paid, lived closer, had a higher education, and had longer experience in their role, with their current manager, and in the company.  That is all interesting but I'll need to test a few things to get a better idea of what is causing an employee to leave Frito Lay.  

### Determining splits by age group
I'd like to know how many employees exist in each age group among the training data set.  To do, I'll create a table showing the frequency of each age group.
```{r Age Groups}
table(trainData$AgeGroup) %>% kable() %>% kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```
### Prepare to make predictions by removing highly correlated data points
Looking back to the correlation data, there are some points which feature high correlation and likely contribute to the data in the same way.  Some of these aren't surprising.  Take Performance Rating and Percent Salary Hike.  It seems logical to expect those with higher performance rating to earn the highest salary increases.  Also Total Working Years and Job Level.  You expect someone who has worked for a number of years to have a higher job role.  

To address these, I'm going to drop some variables from the data set.  I may change these values later but for now, will drop Years Since Last Promotion, as it is highly correlated to a number of other variables, Total Working Years, as Age Group can account for this data point adequately, and Percent Salary Hike as Performance Rating would appear to account for this in the set.
```{r, Drop Correlated Columns}
dropColumns <- c("YearsSinceLastPromotion", "TotalWorkingYears", "PercentSalaryHike")
trainData <- trainData[, !(names(trainData) %in% dropColumns)]
attritionData <- attritionData[, !(names(attritionData) %in% dropColumns)]
salaryData <- salaryData[, !(names(salaryData) %in% dropColumns)]
```
### Create training and test data sets from trainData
To properly train and test based on the trainData, I need to split that data set into a training set and a testing set.
``` {r, Split Set for Train and Test}
set.seed(1234)
splitPercentage <- createDataPartition(y= trainData$Attrition, p=.75, list = FALSE)
trainSet <- trainData[splitPercentage, ]
testSet <- trainData[-splitPercentage, ]
```
## Classification Prediction - Attrition

### Begin with a Naive Bayes Model to predict classification
I start out trying to predict the attrition data with a Naive BAyes Model.
```{r, Naive Bayes Attrition Prediction}
nbModel <- naiveBayes(Attrition ~ ., data=trainSet)

#predict with test
attritionPrediction <- predict(nbModel, testSet)
nbMatrix <- table(attritionPrediction, testSet$Attrition)
confusionMatrix(nbMatrix)
plot(nbMatrix)
```



